# ERA_V3_Session22_Qwen2_5_(3B)_GRPO

| Link to Code | [Colab](https://github.com/garima-mahato/ERA_V3/blob/main/Session22/ERA_V3_Session22_Qwen2_5_(3B)_GRPO.ipynb) |

This repository contains the implementation of GRPO (Gradient-based Reward Policy Optimization) applied to the Qwen2.5 (3B) model. In this project, GRPO is used as a fine-tuning technique to further improve the model’s performance on task-specific conversational data.

## What is GRPO?

GRPO (Gradient-based Reward Policy Optimization) is a reinforcement learning–inspired optimization method that fine-tunes language models by incorporating reward signals. Instead of only relying on the conventional maximum likelihood training objective, GRPO leverages a reward model to guide the fine-tuning process, ensuring that the generated outputs are not only fluent but also aligned with desired behaviors and quality standards.

## What is the Qwen2 5 (3B) Model?

The Qwen2.5 (3B) model is a 3-billion-parameter language model designed for efficient and high-quality text generation. It is well-suited for chat and conversational tasks, and when combined with GRPO, it benefits from enhanced responsiveness and alignment with specific task objectives.

## GRPO Implementation in This Project

In this repository, GRPO is implemented as follows:
- **Reward Signal Integration:** During training, a reward model evaluates generated responses. The gradients from this reward signal are used to adjust the model's parameters, steering the generation toward more desirable outputs.
- **Custom Training Loop:** The notebook implements a custom training loop that logs training metrics (loss, reward, and performance indicators) at each epoch.
- **Chat Templating:** A custom chat template is applied to structure multi-turn conversations. This ensures that the model’s inputs during fine-tuning match the format it expects during inference.

## Training Logs

Below are sample excerpts from the training logs captured during the GRPO fine-tuning process:

```
Step	Training Loss	reward	reward_std	completion_length	kl	rewards / xmlcount_reward_func	rewards / soft_format_reward_func	rewards / strict_format_reward_func	rewards / int_reward_func	rewards / correctness_reward_func
1	0.000000	0.125000	0.000000	200.000000	0.000000	0.125000	0.000000	0.000000	0.000000	0.000000
2	0.000000	0.125000	0.000000	200.000000	0.000000	0.125000	0.000000	0.000000	0.000000	0.000000
3	-0.000000	-0.008250	0.247750	200.000000	0.000000	-0.008250	0.000000	0.000000	0.000000	0.000000
4	0.000000	0.125000	0.000000	200.000000	0.000006	0.125000	0.000000	0.000000	0.000000	0.000000
5	0.000000	-0.074250	0.179036	198.625000	0.000005	-0.074250	0.000000	0.000000	0.000000	0.000000
6	0.000000	0.125000	0.000000	200.000000	0.000004	0.125000	0.000000	0.000000	0.000000	0.000000
7	0.000000	0.125000	0.000000	200.000000	0.000007	0.125000	0.000000	0.000000	0.000000	0.000000
8	0.000000	-0.013875	0.257480	200.000000	0.000021	-0.013875	0.000000	0.000000	0.000000	0.000000
9	0.000000	0.125000	0.000000	200.000000	0.000012	0.125000	0.000000	0.000000	0.000000	0.000000
10	0.000000	0.125000	0.000000	200.000000	0.000008	0.125000	0.000000	0.000000	0.000000	0.000000
11	0.000000	0.505250	1.170489	194.250000	0.000035	-0.119750	0.000000	0.000000	0.125000	0.500000
12	0.000000	0.125000	0.000000	200.000000	0.000018	0.125000	0.000000	0.000000	0.000000	0.000000
13	0.000000	0.041125	0.127246	194.625000	0.000037	0.041125	0.000000	0.000000	0.000000	0.000000
14	0.000000	0.059125	0.186323	200.000000	0.000034	0.059125	0.000000	0.000000	0.000000	0.000000
15	0.000000	0.125000	0.000000	200.000000	0.000034	0.125000	0.000000	0.000000	0.000000	0.000000
16	0.000000	-0.067625	0.298743	195.250000	0.000149	-0.067625	0.000000	0.000000	0.000000	0.000000
17	0.000000	0.156250	0.057864	200.000000	0.000133	0.156250	0.000000	0.000000	0.000000	0.000000
18	0.000000	0.140625	0.044194	200.000000	0.000137	0.140625	0.000000	0.000000	0.000000	0.000000
19	0.000000	0.005125	0.225897	200.000000	0.000124	0.005125	0.000000	0.000000	0.000000	0.000000
20	0.000000	0.125000	0.000000	200.000000	0.000082	0.125000	0.000000	0.000000	0.000000	0.000000
21	0.000000	0.063875	0.175733	200.000000	0.000263	0.001375	0.000000	0.000000	0.062500	0.000000
22	0.000000	-0.039500	0.153563	172.875000	0.000829	-0.039500	0.000000	0.000000	0.000000	0.000000
23	0.000000	0.364375	0.861365	170.250000	0.000634	0.051875	0.000000	0.000000	0.062500	0.250000
24	0.000000	0.003750	0.169383	187.875000	0.000399	0.003750	0.000000	0.000000	0.000000	0.000000
25	0.000000	-0.058375	0.135546	169.000000	0.000995	-0.058375	0.000000	0.000000	0.000000	0.000000
26	0.000000	-0.019750	0.163755	196.875000	0.000979	-0.019750	0.000000	0.000000	0.000000	0.000000
27	0.000100	0.253875	0.956331	186.750000	0.001563	-0.058625	0.000000	0.000000	0.062500	0.250000
28	0.000100	0.022875	0.089029	174.250000	0.002178	0.022875	0.000000	0.000000	0.000000	0.000000
29	0.000100	-0.056875	0.261566	196.250000	0.001981	-0.056875	0.000000	0.000000	0.000000	0.000000
30	0.000100	-0.040375	0.233741	184.125000	0.001905	-0.040375	0.000000	0.000000	0.000000	0.000000
31	0.000700	0.072375	0.039706	116.625000	0.018541	0.072375	0.000000	0.000000	0.000000	0.000000
32	0.000100	0.415125	0.820597	197.125000	0.002653	0.102625	0.000000	0.000000	0.062500	0.250000
33	0.000200	0.003500	0.140416	190.000000	0.004056	0.003500	0.000000	0.000000	0.000000	0.000000
34	0.000000	0.125000	0.000000	200.000000	0.001204	0.125000	0.000000	0.000000	0.000000	0.000000
35	0.000200	0.284000	0.860125	197.125000	0.005150	-0.028500	0.000000	0.000000	0.062500	0.250000
36	0.000100	0.078375	0.131875	200.000000	0.003291	0.078375	0.000000	0.000000	0.000000	0.000000
37	0.000200	0.341125	0.873955	194.250000	0.004155	-0.033875	0.000000	0.000000	0.125000	0.250000
38	0.000500	-0.073000	0.216212	198.500000	0.011759	-0.073000	0.000000	0.000000	0.000000	0.000000
39	0.000100	0.421750	0.839336	197.375000	0.003586	0.109250	0.000000	0.000000	0.062500	0.250000
40	0.000100	0.125000	0.000000	200.000000	0.002542	0.125000	0.000000	0.000000	0.000000	0.000000
41	0.001000	0.125000	0.000000	200.000000	0.023990	0.125000	0.000000	0.000000	0.000000	0.000000
42	0.000500	1.291875	1.216318	186.000000	0.011525	0.041875	0.000000	0.000000	0.250000	1.000000
43	0.000100	0.125000	0.000000	200.000000	0.003310	0.125000	0.000000	0.000000	0.000000	0.000000
44	0.000100	0.125000	0.000000	200.000000	0.002535	0.125000	0.000000	0.000000	0.000000	0.000000
45	0.000100	0.125000	0.000000	200.000000	0.002993	0.125000	0.000000	0.000000	0.000000	0.000000
46	0.001000	1.318250	1.229416	171.250000	0.025406	0.068250	0.000000	0.000000	0.250000	1.000000
47	0.001400	1.657375	1.271439	167.500000	0.034471	0.094875	0.000000	0.000000	0.312500	1.250000
48	0.000200	0.125000	0.000000	200.000000	0.005246	0.125000	0.000000	0.000000	0.000000	0.000000
49	0.000400	0.711625	1.086297	190.375000	0.009134	0.086625	0.000000	0.000000	0.125000	0.500000
50	0.000100	0.125000	0.000000	200.000000	0.003721	0.125000	0.000000	0.000000	0.000000	0.000000
51	0.000500	0.013500	0.141229	183.250000	0.012688	0.013500	0.000000	0.000000	0.000000	0.000000
52	0.000100	0.125000	0.000000	200.000000	0.002205	0.125000	0.000000	0.000000	0.000000	0.000000
53	0.000800	1.650000	1.191052	174.125000	0.019770	0.025000	0.000000	0.000000	0.375000	1.250000
54	0.000300	0.086750	0.157721	199.625000	0.007038	0.086750	0.000000	0.000000	0.000000	0.000000
55	0.001000	0.140500	0.198040	157.250000	0.023852	-0.047000	0.000000	0.000000	0.187500	0.000000
56	0.000200	0.125000	0.000000	200.000000	0.004621	0.125000	0.000000	0.000000	0.000000	0.000000
57	0.000300	0.404125	0.789485	199.875000	0.007832	0.091625	0.000000	0.000000	0.062500	0.250000
58	0.000600	0.043250	0.104773	188.875000	0.015629	0.043250	0.000000	0.000000	0.000000	0.000000
59	0.000100	0.125000	0.000000	200.000000	0.002379	0.125000	0.000000	0.000000	0.000000	0.000000
60	0.001000	0.695250	1.132682	133.125000	0.024082	0.070250	0.000000	0.000000	0.125000	0.500000
61	0.000300	0.116000	0.087657	197.500000	0.006966	0.116000	0.000000	0.000000	0.000000	0.000000
62	0.000500	0.048250	0.146821	196.875000	0.013083	0.048250	0.000000	0.000000	0.000000	0.000000
63	0.000100	0.125000	0.000000	200.000000	0.002059	0.125000	0.000000	0.000000	0.000000	0.000000
64	0.000100	0.140625	0.044194	200.000000	0.002875	0.140625	0.000000	0.000000	0.000000	0.000000
65	0.001600	0.479750	0.884492	167.750000	0.038975	-0.082750	0.000000	0.000000	0.312500	0.250000
66	0.001100	1.973375	1.141851	166.625000	0.026888	0.098375	0.000000	0.000000	0.375000	1.500000
67	0.000100	0.125000	0.000000	200.000000	0.002705	0.125000	0.000000	0.000000	0.000000	0.000000
68	0.000100	0.125000	0.000000	200.000000	0.003520	0.125000	0.000000	0.000000	0.000000	0.000000
69	0.000100	0.125000	0.000000	200.000000	0.002121	0.125000	0.000000	0.000000	0.000000	0.000000
70	0.002000	0.656125	1.121998	171.000000	0.049893	0.031125	0.000000	0.000000	0.125000	0.500000
71	0.000700	1.047625	0.986484	191.625000	0.017679	0.047625	0.000000	0.000000	0.000000	1.000000
72	0.000200	0.125000	0.000000	200.000000	0.003943	0.125000	0.000000	0.000000	0.000000	0.000000
73	0.000400	1.303500	1.227341	180.375000	0.010162	0.053500	0.000000	0.000000	0.250000	1.000000
74	0.000200	0.125000	0.000000	200.000000	0.004660	0.125000	0.000000	0.000000	0.000000	0.000000
75	0.000400	0.691625	1.049636	197.000000	0.009125	0.066625	0.000000	0.000000	0.125000	0.500000
76	0.001500	2.589625	0.058113	126.750000	0.037494	0.089625	0.000000	0.000000	0.500000	2.000000
77	0.000700	0.418625	0.886296	189.750000	0.018635	0.043625	0.000000	0.000000	0.125000	0.250000
78	0.000200	0.098250	0.133535	200.000000	0.005614	0.098250	0.000000	0.000000	0.000000	0.000000
79	0.002300	2.629125	0.088833	125.125000	0.058145	0.129125	0.000000	0.000000	0.500000	2.000000
80	0.000200	0.428500	0.858428	197.125000	0.005243	0.116000	0.000000	0.000000	0.062500	0.250000
81	0.001300	2.387250	0.973192	143.375000	0.031748	0.137250	0.000000	0.062500	0.437500	1.750000
82	0.001300	1.876750	1.108734	166.875000	0.031639	-0.060750	0.000000	0.000000	0.437500	1.500000
83	0.000700	0.579625	1.128515	190.625000	0.017638	-0.045375	0.000000	0.000000	0.125000	0.500000
84	0.000600	1.022625	1.205283	191.000000	0.015530	0.085125	0.000000	0.000000	0.187500	0.750000
85	0.001000	0.424375	0.143404	160.250000	0.023923	-0.075625	0.000000	0.000000	0.500000	0.000000
86	0.001100	2.562750	0.079941	140.125000	0.028190	0.062750	0.000000	0.000000	0.500000	2.000000
87	0.001500	0.075250	0.091286	130.750000	0.037475	0.075250	0.000000	0.000000	0.000000	0.000000
88	0.002300	2.456125	0.125772	165.000000	0.058533	-0.043875	0.000000	0.000000	0.500000	2.000000
89	0.001000	0.419250	0.795023	187.750000	0.023853	0.044250	0.000000	0.062500	0.062500	0.250000
90	0.001500	0.877500	0.707124	135.375000	0.038046	0.127500	0.000000	0.000000	0.500000	0.250000
91	0.001900	2.699125	0.061487	110.750000	0.047205	0.199125	0.000000	0.000000	0.500000	2.000000
92	0.001100	0.844375	1.076828	176.875000	0.028263	0.094375	0.000000	0.000000	0.250000	0.500000
93	0.002300	0.382375	0.938398	146.875000	0.057177	0.069875	0.000000	0.000000	0.062500	0.250000
94	0.002700	1.234625	1.105780	141.250000	0.068107	0.047125	0.000000	0.000000	0.437500	0.750000
95	0.000600	1.118000	1.125978	160.500000	0.014819	-0.007000	0.000000	0.000000	0.375000	0.750000
96	0.001100	0.410125	0.865917	160.250000	0.027084	0.035125	0.000000	0.000000	0.125000	0.250000
97	0.000700	0.144500	0.182145	193.250000	0.018073	0.082000	0.000000	0.000000	0.062500	0.000000
98	0.001800	0.456250	0.876849	114.375000	0.045262	0.143750	0.000000	0.000000	0.062500	0.250000
99	0.001600	1.317000	1.253549	170.375000	0.040735	0.067000	0.000000	0.000000	0.250000	1.000000
100	0.005500	1.385375	1.337718	143.250000	0.138479	0.072875	0.000000	0.000000	0.312500	1.000000
101	0.002900	1.722750	1.219510	135.750000	0.071924	0.097750	0.000000	0.000000	0.375000	1.250000
102	0.001000	0.390125	0.902624	172.375000	0.025692	0.077625	0.000000	0.000000	0.062500	0.250000
103	0.003700	2.755250	0.025223	74.375000	0.092806	0.255250	0.000000	0.000000	0.500000	2.000000
104	0.002200	1.850375	1.159723	130.750000	0.055529	0.162875	0.000000	0.000000	0.437500	1.250000
105	0.002300	1.690500	1.116723	169.875000	0.057977	0.003000	0.000000	0.000000	0.437500	1.250000
106	0.002900	2.637750	0.034087	117.500000	0.073165	0.137750	0.000000	0.000000	0.500000	2.000000
107	0.003700	2.715250	0.019002	87.250000	0.093393	0.215250	0.000000	0.000000	0.500000	2.000000
108	0.001500	2.279375	0.877422	144.125000	0.036269	0.091875	0.000000	0.000000	0.437500	1.750000
109	0.003500	2.809625	0.292833	90.375000	0.086872	0.247125	0.000000	0.062500	0.500000	2.000000
110	0.003900	1.768125	1.304613	114.000000	0.098551	0.205625	0.000000	0.000000	0.312500	1.250000
111	0.001500	1.237125	1.364219	165.125000	0.037341	-0.012875	0.000000	0.000000	0.250000	1.000000
112	0.005000	2.695750	0.028182	102.625000	0.125978	0.195750	0.000000	0.000000	0.500000	2.000000
113	0.003500	2.725875	0.051301	102.625000	0.086484	0.225875	0.000000	0.000000	0.500000	2.000000
114	0.002000	0.469625	0.917776	143.875000	0.049425	0.157125	0.000000	0.000000	0.062500	0.250000
115	0.003300	2.002875	1.003568	153.875000	0.081692	0.065375	0.000000	0.000000	0.437500	1.500000
116	0.002600	1.430625	1.201022	151.500000	0.066113	0.118125	0.000000	0.000000	0.312500	1.000000
117	0.002800	2.368250	0.879430	133.625000	0.070827	0.180750	0.000000	0.000000	0.437500	1.750000
118	0.001600	1.075125	1.191119	181.875000	0.040415	0.075125	0.000000	0.000000	0.250000	0.750000
119	0.004000	2.711250	0.085327	91.750000	0.099453	0.211250	0.000000	0.000000	0.500000	2.000000
120	0.003700	2.823750	0.276316	96.625000	0.093023	0.261250	0.000000	0.062500	0.500000	2.000000
121	0.001900	0.376250	0.833116	176.750000	0.047670	0.001250	0.000000	0.000000	0.125000	0.250000
122	0.001600	0.769375	0.795163	169.625000	0.039645	0.081875	0.000000	0.062500	0.375000	0.250000
123	0.001800	2.185375	0.835378	175.875000	0.043980	-0.002125	0.000000	0.000000	0.437500	1.750000
124	0.002100	0.912500	0.704725	115.125000	0.051604	0.162500	0.000000	0.000000	0.500000	0.250000
125	0.002600	0.861625	1.052022	179.250000	0.065748	0.111625	0.000000	0.125000	0.125000	0.500000
126	0.006900	2.693875	0.030050	86.875000	0.171759	0.193875	0.000000	0.000000	0.500000	2.000000
127	0.004800	2.737125	0.310983	129.500000	0.120279	0.174625	0.000000	0.062500	0.500000	2.000000
128	0.005300	3.007750	0.409562	95.250000	0.132349	0.320250	0.000000	0.187500	0.500000	2.000000
129	0.001400	1.313250	1.270512	191.875000	0.035863	0.063250	0.000000	0.000000	0.250000	1.000000
130	0.003500	1.936375	1.594060	168.375000	0.087275	0.373875	0.000000	0.250000	0.312500	1.000000
131	0.006400	2.450625	0.726619	112.250000	0.161041	0.200625	0.000000	0.000000	0.500000	1.750000
132	0.004300	1.065875	0.493676	159.250000	0.107947	0.315875	0.000000	0.250000	0.500000	0.000000
133	0.002900	2.947875	0.459915	126.000000	0.073054	0.260375	0.000000	0.187500	0.500000	2.000000
134	0.003200	2.029250	1.198277	171.750000	0.080605	0.154250	0.000000	0.000000	0.375000	1.500000
135	0.010500	3.500000	0.000000	87.500000	0.262932	0.500000	0.000000	0.500000	0.500000	2.000000
136	0.004900	1.798375	1.639535	161.125000	0.121668	0.298375	0.000000	0.250000	0.250000	1.000000
137	0.006500	3.187500	0.703943	122.500000	0.163053	0.500000	0.000000	0.437500	0.500000	1.750000
138	0.002400	1.578125	1.520599	183.375000	0.060069	0.328125	0.000000	0.000000	0.250000	1.000000
139	0.006400	3.250000	0.707107	96.875000	0.159244	0.500000	0.000000	0.500000	0.500000	1.750000
140	0.003200	1.566875	1.667099	183.750000	0.079383	0.191875	0.000000	0.125000	0.250000	1.000000
141	0.006800	3.500000	0.000000	115.375000	0.171135	0.500000	0.000000	0.500000	0.500000	2.000000
142	0.001100	0.082500	0.120208	200.000000	0.026366	0.082500	0.000000	0.000000	0.000000	0.000000
143	0.005400	2.218750	1.434196	157.625000	0.133958	0.406250	0.000000	0.187500	0.375000	1.250000
144	0.011200	2.000000	0.707107	111.875000	0.279385	0.500000	0.000000	0.437500	0.312500	0.750000
145	0.006900	3.312500	0.258775	123.625000	0.171277	0.500000	0.000000	0.312500	0.500000	2.000000
146	0.001900	0.885250	1.470368	189.000000	0.046345	0.197750	0.000000	0.062500	0.125000	0.500000
147	0.007200	2.735875	1.415207	129.625000	0.179272	0.360875	0.000000	0.375000	0.500000	1.500000

```

## Inference Results


### Before Training

**Example 1:**
- **User:** "How many r's are in strawberry?"
- **Assistant:** "There are 4 r's in strawberry.
reasoning
To determine the number of r's in the word "strawberry," I will count each instance of the letter "r" within the word.
answer
There are 4 r's in the word "strawberry."

**Example 2:**
- **User:** "A concert ticket costs $40. Mr. Benson bought 12 tickets and received a 5% discount for every ticket bought that exceeds 10. How much did Mr. Benson pay in all? "
- **Assistant:** Let's solve this step by step:

<reasoning>

>1. The original cost per ticket is $40.

>2. Mr. Benson bought 12 tickets, which is 2 tickets beyond the initial 10 tickets.

>3. He received a 5% discount for every ticket exceeding 10.

>4. To find the total cost, we need to calculate the cost of the first 10 tickets and the discounted cost of the additional 2 tickets.

>5. Calculate the discounted cost for the additional 2 tickets: (original cost * discount rate) * number of additional tickets = ($40 * 0.05) * 2.

>6. Add the cost of the first 10 tickets to the discounted cost of the additional tickets to get the total amount paid.
</reasoning>

<answer>
The total amount Mr. Benson paid for all 12 tickets is $488.
</answer>


### After Training

**Example 1:**
- **User:** "How many r's are in strawberry?"
- **Assistant:** <reasoning>
>We need to count the number of times the letter 'r' appears in the word "strawberry". The word "strawberry" has the letter 'r' appearing 3 times.
</reasoning>
<answer>
3
</answer>


**Example 2:**
- **User:** "A concert ticket costs $40. Mr. Benson bought 12 tickets and received a 5% discount for every ticket bought that exceeds 10. How much did Mr. Benson pay in all? "
- **Assistant:** <reasoning>
>First, let's calculate the total cost of the 12 tickets without any discount. The cost for each ticket is $40, so the total cost for 12 tickets without any discount is 12 * $4L0 = $480. 

>Next, we determine the number of tickets that qualify for the discount. Since Mr. Benson bought 12 tickets, which is more than 10, he qualifies for the 5% discount on 2 tickets (12 - 10 = 2).

>Now we calculate the discount on those 2 tickets. Since each ticket is discounted by 5%, the discount amount per ticket is 0.05 * $40 = $2. The total discount for 2 tickets is 2 * $2 = $4.

>Next, we find the discounted total for the 12 tickets by subtracting the total discount from the total cost without discount. Therefore, the total cost with discount is $480 - $4 = $476.

</reasoning>
<answer>
 Mr. Benson paid a total of $476 for the 12 concert tickets with the given discount conditions.
</answer>
